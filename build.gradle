plugins {
    id 'java'
    id 'org.springframework.boot' version '3.3.3'
    id 'io.spring.dependency-management' version '1.1.7'
}

group = 'com.carecode'
version = '0.0.1-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(17)
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
    maven { url 'https://jitpack.io' }
    maven { url 'https://repo1.maven.org/maven2/' }
}

dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.boot:spring-boot-starter-batch'
    implementation 'org.springframework.boot:spring-boot-starter-quartz'
    implementation 'org.springframework.boot:spring-boot-starter-aop'

    // Swagger/OpenAPI 3
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.3.0'

    implementation 'io.micrometer:micrometer-registry-prometheus'
    implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
    runtimeOnly 'io.jsonwebtoken:jjwt-impl:0.11.5'
    runtimeOnly 'io.jsonwebtoken:jjwt-jackson:0.11.5'

    compileOnly 'org.projectlombok:lombok'
    runtimeOnly 'com.h2database:h2'
    annotationProcessor 'org.projectlombok:lombok'

    // MapStruct for DTO mappings
    implementation 'org.mapstruct:mapstruct:1.5.5.Final'
    annotationProcessor 'org.mapstruct:mapstruct-processor:1.5.5.Final'
    annotationProcessor 'org.projectlombok:lombok-mapstruct-binding:0.2.0'

    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testImplementation 'org.springframework.security:spring-security-test'
    testImplementation 'org.springframework.batch:spring-batch-test'

    runtimeOnly 'org.mariadb.jdbc:mariadb-java-client'
    // ì†Œì…œ ë¡œê·¸ì¸(OAuth2)
    implementation 'org.springframework.boot:spring-boot-starter-oauth2-client'
    // ì´ë©”ì¼ ì¸ì¦
    implementation 'org.springframework.boot:spring-boot-starter-mail'
    // Redis
    implementation 'org.springframework.boot:spring-boot-starter-data-redis'
    
    // Logging - JSON í˜•ì‹ ë¡œê¹… ì§€ì›
    implementation 'net.logstash.logback:logstash-logback-encoder:7.4'
    
    // AsciiDoctor for documentation generation
    implementation 'org.asciidoctor:asciidoctorj:2.5.7'
    implementation 'org.asciidoctor:asciidoctorj-pdf:2.3.4'
}

tasks.named('test') {
    useJUnitPlatform()
}

// JAR ë¹Œë“œ ìµœì í™”
jar {
    enabled = false
    archiveClassifier = ''
}

// Spring Boot JAR ì„¤ì •
springBoot {
    buildInfo()
}

// í”„ë¡œë•ì…˜ ë¹Œë“œ ìµœì í™”
tasks.named('bootJar') {
    archiveFileName = 'carecode-app.jar'
    
    // ì¤‘ë³µ íŒŒì¼ ì²˜ë¦¬ ì „ëµ ì„¤ì •
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    
    // ë©”íƒ€ë°ì´í„° ì¶”ê°€
    manifest {
        attributes(
            'Implementation-Title': 'CareCode Application',
            'Implementation-Version': version,
            'Built-By': System.getProperty('user.name'),
            'Built-Date': new Date(),
            'Built-JDK': System.getProperty('java.version')
        )
    }
    
    // ë¦¬ì†ŒìŠ¤ ìµœì í™”
    from('src/main/resources') {
        include '**/*'
        into 'BOOT-INF/classes'
        duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    }
}

// í”„ë¡œíŒŒì¼ë³„ ë¹Œë“œ íƒœìŠ¤í¬
task buildRelease {
    dependsOn bootJar
    doLast {
        println "âœ… í”„ë¡œë•ì…˜ JAR ë¹Œë“œ ì™„ë£Œ: ${bootJar.archiveFile.get()}"
        println "ğŸ“¦ íŒŒì¼ í¬ê¸°: ${bootJar.archiveFile.get().asFile.length() / 1024 / 1024} MB"
    }
}

// Docker ë¹Œë“œìš© íƒœìŠ¤í¬
task buildDocker {
    dependsOn bootJar
    doLast {
        copy {
            from bootJar
            into 'build/docker'
            rename { String fileName ->
                'app.jar'
            }
        }
        println "âœ… Docker ë¹Œë“œìš© JAR ì¤€ë¹„ ì™„ë£Œ"
    }
}

// API ë¬¸ì„œ ìƒì„± íƒœìŠ¤í¬
task generateApiDocs {
    doLast {
        def outputDir = file('src/docs/asciidoc')
        outputDir.mkdirs()
        
        // Swagger JSON ë‹¤ìš´ë¡œë“œ (í™˜ê²½ ë³€ìˆ˜ ë˜ëŠ” gradle -P ë¡œ ì£¼ì… ê°€ëŠ¥)
        def serverUrl = System.getenv('SWAGGER_SERVER_URL') ?: (project.hasProperty('swaggerServerUrl') ? project.getProperty('swaggerServerUrl') : 'http://localhost:8081')
        def swaggerUrl = serverUrl + '/v3/api-docs'
        def swaggerFile = file('swagger.json')
        
        new URL(swaggerUrl).withInputStream { input ->
            swaggerFile.withOutputStream { output ->
                output << input
            }
        }
        
        println "âœ… Swagger JSON ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
        println "ğŸ“ ì¶œë ¥ ë””ë ‰í† ë¦¬: ${outputDir.absolutePath}"
        println "ğŸ“„ Swagger JSON: ${swaggerFile.absolutePath}"
    }
}

// ìƒì„¸ API ë¬¸ì„œ ìƒì„±
task generateDetailedApiDocs {
    doLast {
        def outputDir = file('src/docs/asciidoc')
        outputDir.mkdirs()
        
        println "ğŸš€ ìƒì„¸ API ë¬¸ì„œ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
        println "ğŸ“ ì¶œë ¥ ë””ë ‰í† ë¦¬: ${outputDir.absolutePath}"
        
        // API ë¬¸ì„œ ìƒì„±ê¸° ì‹¤í–‰
        def detailedDocFile = file('src/docs/asciidoc/api-docs-detailed.adoc')
        
        javaexec {
            classpath = sourceSets.main.runtimeClasspath
            mainClass = 'com.carecode.docs.ApiDocumentationGenerator'
            def serverUrl = System.getenv('SWAGGER_SERVER_URL') ?: (project.hasProperty('swaggerServerUrl') ? project.getProperty('swaggerServerUrl') : 'http://localhost:8081')
            args = [serverUrl + '/api-docs', detailedDocFile.absolutePath]
        }
        
        println "âœ… ìƒì„¸ API ë¬¸ì„œ ìƒì„± ì™„ë£Œ: ${detailedDocFile.absolutePath}"
    }
}

// ê°„ë‹¨í•œ API ëª©ë¡ ìƒì„±
task generateApiList {
    doLast {
        def outputDir = file('src/docs/asciidoc')
        outputDir.mkdirs()
        
        println "ğŸš€ API ëª©ë¡ ìƒì„±ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
        println "ğŸ“ ì¶œë ¥ ë””ë ‰í† ë¦¬: ${outputDir.absolutePath}"
        
        // ê°„ë‹¨í•œ API ëª©ë¡ ìƒì„±
        def apiListFile = file('src/docs/asciidoc/api-list.adoc')
        def apiListContent = generateApiListContent()
        apiListFile.text = apiListContent
        
        println "âœ… API ëª©ë¡ ìƒì„± ì™„ë£Œ: ${apiListFile.absolutePath}"
    }
}

// API ëª©ë¡ ìƒì„± í•¨ìˆ˜
def generateApiListContent() {
    def asciiDoc = new StringBuilder()
    
    // ê¸°ë³¸ í—¤ë”
    asciiDoc.append("= CareCode API ëª©ë¡\n")
    asciiDoc.append(":toc: left\n")
    asciiDoc.append(":toclevels: 2\n")
    asciiDoc.append(":sectnums:\n")
    asciiDoc.append(":icons: font\n\n")
    
    asciiDoc.append("== ê°œìš”\n\n")
    asciiDoc.append("CareCode APIì˜ ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸ ëª©ë¡ì…ë‹ˆë‹¤.\n\n")
    
    // API ê·¸ë£¹ë³„ ëª©ë¡
    def apiGroups = [
        "ì¸ì¦": [
            ["POST /auth/login", "ë¡œê·¸ì¸"],
            ["POST /auth/register", "íšŒì›ê°€ì…"],
            ["POST /auth/logout", "ë¡œê·¸ì•„ì›ƒ"],
            ["GET /auth/me", "í˜„ì¬ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ"]
        ],
        "ìœ¡ì•„ì‹œì„¤": [
            ["GET /facilities", "ì‹œì„¤ ëª©ë¡ ì¡°íšŒ"],
            ["GET /facilities/{id}", "ì‹œì„¤ ìƒì„¸ ì¡°íšŒ"],
            ["POST /facilities/search", "ì‹œì„¤ ê²€ìƒ‰"],
            ["POST /facilities/{id}/bookings", "ì˜ˆì•½ ìƒì„±"]
        ],
        "ì»¤ë®¤ë‹ˆí‹°": [
            ["GET /community/posts", "ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒ"],
            ["POST /community/posts", "ê²Œì‹œê¸€ ì‘ì„±"],
            ["GET /community/posts/{id}", "ê²Œì‹œê¸€ ìƒì„¸ ì¡°íšŒ"]
        ],
        "ê±´ê°•ê´€ë¦¬": [
            ["GET /health/records", "ê±´ê°•ê¸°ë¡ ì¡°íšŒ"],
            ["POST /health/records", "ê±´ê°•ê¸°ë¡ ë“±ë¡"],
            ["GET /health/statistics", "ê±´ê°• í†µê³„ ì¡°íšŒ"]
        ],
        "ì •ì±…ì •ë³´": [
            ["GET /policies", "ì •ì±… ëª©ë¡ ì¡°íšŒ"],
            ["GET /policies/{id}", "ì •ì±… ìƒì„¸ ì¡°íšŒ"],
            ["POST /policies/search", "ì •ì±… ê²€ìƒ‰"]
        ],
        "ì±—ë´‡": [
            ["POST /chatbot/chat", "ì±—ë´‡ ëŒ€í™”"],
            ["GET /chatbot/sessions", "ì„¸ì…˜ ëª©ë¡ ì¡°íšŒ"]
        ],
        "ì•Œë¦¼": [
            ["GET /notifications", "ì•Œë¦¼ ëª©ë¡ ì¡°íšŒ"],
            ["POST /notifications", "ì•Œë¦¼ ìƒì„±"]
        ]
    ]
    
    apiGroups.each { tag, apis ->
        asciiDoc.append("== ${tag}\n\n")
        apis.each { api ->
            asciiDoc.append("* `${api[0]}` - ${api[1]}\n")
        }
        asciiDoc.append("\n")
    }
    
    return asciiDoc.toString()
}

// AsciiDoc í…œí”Œë¦¿ ìƒì„±
task createAsciiDocTemplate {
    doLast {
        def templateDir = file('src/docs/templates')
        templateDir.mkdirs()
        
        def template = file('src/docs/templates/api-docs.adoc')
        template.text = '''= CareCode API ë¬¸ì„œ
:toc: left
:toclevels: 3
:sectnums:
:source-highlighter: highlightjs
:icons: font

== ê°œìš”

CareCode APIëŠ” ìœ¡ì•„ ì •ë³´ í”Œë«í¼ì„ ìœ„í•œ RESTful APIì…ë‹ˆë‹¤.

=== ê¸°ë³¸ ì •ë³´

* **Base URL**: `http://13.209.36.209:8081`
* **API ë²„ì „**: v1
* **ì¸ì¦**: JWT Bearer Token

== ì¸ì¦

=== JWT í† í°

API ìš”ì²­ ì‹œ Authorization í—¤ë”ì— JWT í† í°ì„ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤:

[source,http]
----
Authorization: Bearer <your-jwt-token>
----

== API ì—”ë“œí¬ì¸íŠ¸

=== ì‚¬ìš©ì ê´€ë¦¬

==== ë¡œê·¸ì¸
[source,http]
----
POST /auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password"
}
----

==== íšŒì›ê°€ì…
[source,http]
----
POST /auth/register
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password",
  "name": "ì‚¬ìš©ìëª…"
}
----

=== ìœ¡ì•„ì‹œì„¤

==== ì‹œì„¤ ëª©ë¡ ì¡°íšŒ
[source,http]
----
GET /api/facilities?page=0&size=10
Authorization: Bearer <token>
----

==== ì‹œì„¤ ìƒì„¸ ì¡°íšŒ
[source,http]
----
GET /api/facilities/{id}
Authorization: Bearer <token>
----

=== ì»¤ë®¤ë‹ˆí‹°

==== ê²Œì‹œê¸€ ëª©ë¡
[source,http]
----
GET /api/community/posts?page=0&size=10
Authorization: Bearer <token>
----

==== ê²Œì‹œê¸€ ì‘ì„±
[source,http]
----
POST /api/community/posts
Authorization: Bearer <token>
Content-Type: application/json

{
  "title": "ì œëª©",
  "content": "ë‚´ìš©",
  "category": "GENERAL"
}
----

=== ê±´ê°•ê´€ë¦¬

==== ê±´ê°•ê¸°ë¡ ì¡°íšŒ
[source,http]
----
GET /api/health/records?childId={childId}
Authorization: Bearer <token>
----

==== ê±´ê°•ê¸°ë¡ ë“±ë¡
[source,http]
----
POST /api/health/records
Authorization: Bearer <token>
Content-Type: multipart/form-data

{
  "childId": 1,
  "recordType": "VACCINATION",
  "title": "ì˜ˆë°©ì ‘ì¢…",
  "description": "ì ‘ì¢… ë‚´ìš©",
  "recordDate": "2024-01-15"
}
----

=== ì •ì±…ì •ë³´

==== ì •ì±… ëª©ë¡
[source,http]
----
GET /api/policies?category=EDUCATION&page=0&size=10
Authorization: Bearer <token>
----

==== ì •ì±… ìƒì„¸
[source,http]
----
GET /api/policies/{id}
Authorization: Bearer <token>
----

=== ì±—ë´‡

==== ì±„íŒ… ì‹œì‘
[source,http]
----
POST /api/chatbot/sessions
Authorization: Bearer <token>
Content-Type: application/json

{
  "message": "ì•ˆë…•í•˜ì„¸ìš”"
}
----

==== ë©”ì‹œì§€ ì „ì†¡
[source,http]
----
POST /api/chatbot/sessions/{sessionId}/messages
Authorization: Bearer <token>
Content-Type: application/json

{
  "message": "ìœ¡ì•„ ì‹œì„¤ ì¶”ì²œí•´ì£¼ì„¸ìš”"
}
----

== ì‘ë‹µ ì½”ë“œ

|ì½”ë“œ|ì„¤ëª…|
|---|---|
|200|ì„±ê³µ|
|201|ìƒì„±ë¨|
|400|ì˜ëª»ëœ ìš”ì²­|
|401|ì¸ì¦ ì‹¤íŒ¨|
|403|ê¶Œí•œ ì—†ìŒ|
|404|ì°¾ì„ ìˆ˜ ì—†ìŒ|
|500|ì„œë²„ ì˜¤ë¥˜|

== ì—ëŸ¬ ì‘ë‹µ

[source,json]
----
{
  "timestamp": "2024-01-15T10:30:00",
  "status": 400,
  "error": "Bad Request",
  "message": "ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤",
  "path": "/api/facilities"
}
----

== ë°ì´í„° ëª¨ë¸

=== ì‚¬ìš©ì (User)

[source,json]
----
{
  "id": 1,
  "email": "user@example.com",
  "name": "ì‚¬ìš©ìëª…",
  "role": "USER",
  "createdAt": "2024-01-15T10:30:00",
  "updatedAt": "2024-01-15T10:30:00"
}
----

=== ìœ¡ì•„ì‹œì„¤ (CareFacility)

[source,json]
----
{
  "id": 1,
  "name": "í–‰ë³µí•œ ì–´ë¦°ì´ì§‘",
  "address": "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬",
  "phone": "02-1234-5678",
  "capacity": 50,
  "currentCount": 30,
  "rating": 4.5,
  "facilityType": "KINDERGARTEN"
}
----

=== ê²Œì‹œê¸€ (Post)

[source,json]
----
{
  "id": 1,
  "title": "ìœ¡ì•„ íŒ ê³µìœ ",
  "content": "ìœ¡ì•„ì— ë„ì›€ì´ ë˜ëŠ” íŒì…ë‹ˆë‹¤",
  "author": {
    "id": 1,
    "name": "ì‚¬ìš©ìëª…"
  },
  "category": "GENERAL",
  "createdAt": "2024-01-15T10:30:00",
  "viewCount": 10,
  "likeCount": 5
}
----

== ê°œë°œ í™˜ê²½ ì„¤ì •

=== ë¡œì»¬ ê°œë°œ

1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰:
   ```bash
   ./gradlew bootRun
   ```

2. Swagger UI ì ‘ì†:
   ```
   http://13.209.36.209:8081/swagger-ui.html
   ```

3. API ë¬¸ì„œ ìƒì„±:
   ```bash
   ./gradlew generateApiDocs
   ```

=== í…ŒìŠ¤íŠ¸

API í…ŒìŠ¤íŠ¸ëŠ” Postmanì´ë‚˜ curlì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

[source,bash]
----
# ë¡œê·¸ì¸
curl -X POST http://13.209.36.209:8081/auth/login \\
  -H "Content-Type: application/json" \\
  -d '{"email":"user@example.com","password":"password"}'

# í† í°ìœ¼ë¡œ API í˜¸ì¶œ
curl -X GET http://13.209.36.209:8081/api/facilities \\
  -H "Authorization: Bearer <your-token>"
----
'''
        
        println "âœ… AsciiDoc í…œí”Œë¦¿ ìƒì„± ì™„ë£Œ: ${template.absolutePath}"
    }
}
